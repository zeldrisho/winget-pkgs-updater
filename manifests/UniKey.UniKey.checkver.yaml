packageIdentifier: UniKey.UniKey
manifestPath: manifests/u/UniKey/UniKey
checkver:
  type: script
  script: |
    $downloadPage = Invoke-WebRequest -Uri "https://unikey.org/download.html" -UseBasicParsing
    
    $builds = @{
        x64 = $null
        x86 = $null
        arm64 = $null
    }
    $rcVersion = $null
    
    if ($downloadPage.Content -match 'unikey(?<rc>[\d]+[Rr][Cc]\.?\d+)-(?<build>\d+)-win64\.zip') {
        $builds.x64 = $Matches['build']
        $rcVersion = $Matches['rc']
    }
    
    if ($downloadPage.Content -match 'unikey(?<rc>[\d]+[Rr][Cc]\.?\d+)-(?<build>\d+)-win32\.zip') {
        $builds.x86 = $Matches['build']
        if (-not $rcVersion) { $rcVersion = $Matches['rc'] }
    }
    
    if ($downloadPage.Content -match 'unikey(?<rc>[\d]+[Rr][Cc]\.?\d+)-(?<build>\d+)-arm64\.zip') {
        $builds.arm64 = $Matches['build']
        if (-not $rcVersion) { $rcVersion = $Matches['rc'] }
    }
    
    $buildValues = $builds.Values | Where-Object { $_ -ne $null } | ForEach-Object { [int]$_ }
    
    if ($buildValues.Count -eq 0 -or -not $rcVersion) {
        Write-Error "Could not find UniKey versions on download page"
        exit 1
    }
    
    $latestBuild = ($buildValues | Measure-Object -Maximum).Maximum
    
    $homePage = Invoke-WebRequest -Uri "https://www.unikey.org/" -UseBasicParsing
    $releaseNotes = ""
    $releaseNotesUrl = ""
    
    if ($homePage.Content -match 'Ngày\s+\d+/\d+/2025:[^<]*<[^>]*>Phát hành[^<]*<a href="([^"]+)"[^>]*>([^<]+)</a>([^<]*)') {
        $releaseNotesUrl = $Matches[1]
        if (-not $releaseNotesUrl.StartsWith('http')) {
            $releaseNotesUrl = "https://www.unikey.org$releaseNotesUrl"
        }
        
        $linkText = $Matches[2] + $Matches[3]
        $linkText = $linkText -replace '<[^>]+>', '' -replace '\s+', ' '
        $releaseNotes = "Released $linkText".Trim()
    }
    
    if (-not $releaseNotes -and $builds.arm64 -eq $latestBuild) {
        $releaseNotesUrl = "https://www.unikey.org/unikey_arm64.html"
        $releaseNotes = "Released 4.6 RC2 ARM64 native build for Windows 11 with Snapdragon processors"
    }
    
    if ($rcVersion -match '^(\d)(\d+)[Rr][Cc](\d+)') {
        $major = $Matches[1]
        $minor = $Matches[2]
        $rcNumber = $Matches[3]
        $wingetVersion = "$major.$minor.$latestBuild"
        
        $output = "$wingetVersion|$rcVersion|$($builds.x64)|$($builds.x86)|$($builds.arm64)|$releaseNotes|$releaseNotesUrl"
        Write-Output $output
    } else {
        Write-Error "Could not parse RC version: $rcVersion"
        exit 1
    }
  regex: "(?P<version>[\\d\\.]+)\\|(?P<rcversion>[^\\|]+)\\|(?P<buildx64>[^\\|]+)\\|(?P<buildx86>[^\\|]+)\\|(?P<buildarm64>[^\\|]+)\\|(?P<releasenotes>[^\\|]*)\\|(?P<releasenotesurl>.*)"

installerUrlTemplate:
  x64: "https://unikey.org/assets/release/unikey{rcversion}-{buildx64}-win64.zip"
  x86: "https://unikey.org/assets/release/unikey{rcversion}-{buildx86}-win32.zip"
  arm64: "https://unikey.org/assets/release/unikey{rcversion}-{buildarm64}-arm64.zip"

