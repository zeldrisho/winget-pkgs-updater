name: Update WinGet Packages

on:
  schedule:
    # Run every 4 hours
    - cron: '20 */4 * * *'
  workflow_dispatch:
    inputs:
      package:
        description: 'Package name (leave empty for all packages)'
        required: false
        type: string

permissions:
  contents: read
  pull-requests: write

jobs:
  update:
    name: Check and Update Packages
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup PowerShell modules
        shell: pwsh
        run: |
          if (-not (Get-Module -ListAvailable -Name powershell-yaml)) {
            Install-Module -Name powershell-yaml -Force -Scope CurrentUser
          }
          Write-Host "‚úÖ PowerShell modules ready"

      - name: Run package updater
        shell: pwsh
        run: |
          # Find checkver files
          if ("${{ github.event.inputs.package }}") {
            $checkverFiles = Get-ChildItem -Path manifests -Filter "${{ github.event.inputs.package }}.checkver.yaml" -Recurse
          } else {
            $checkverFiles = Get-ChildItem -Path manifests -Filter "*.checkver.yaml" -Recurse
          }

          Write-Host "Found $($checkverFiles.Count) checkver file(s)" -ForegroundColor Cyan

          foreach ($file in $checkverFiles) {
            Write-Host "`n========================================" -ForegroundColor Cyan
            Write-Host "Processing: $($file.Name)" -ForegroundColor Cyan
            Write-Host "========================================" -ForegroundColor Cyan

            try {
              # Automated Update Flow:
              # Step 1: Check latest version in microsoft/winget-pkgs
              # Step 2: Check latest version from package homepage/source
              # Step 3: Compare versions to determine if update is needed
              # Step 4: Check if PR already exists for this version
              # Step 5: Create manifests, calculate hashes, and validate
              # Step 6: Create PR if validation passes

              # Cleanup any previous version info
              if (Test-Path "version_info.json") {
                Remove-Item "version_info.json" -Force
              }

              # Steps 1-4: Check for updates (includes version comparison + PR check)
              pwsh -File scripts/Check-Version.ps1 "$($file.FullName)" "version_info.json"

              if ($LASTEXITCODE -eq 0 -and (Test-Path "version_info.json")) {
                # Parse version information
                $versionInfo = Get-Content "version_info.json" -Raw | ConvertFrom-Json
                $packageId = $versionInfo.packageIdentifier
                $version = $versionInfo.version

                Write-Host "‚ú® New version detected: $packageId $version" -ForegroundColor Green

                # Step 5: Create manifest update and PR
                Write-Host "üöÄ Creating manifest update and PR..." -ForegroundColor Green
                pwsh -File scripts/Update-Manifest.ps1 "$($file.FullName)" "$packageId" "$version"

                if ($LASTEXITCODE -ne 0) {
                  Remove-Item "version_info.json" -Force -ErrorAction SilentlyContinue
                  throw "Update-Manifest.ps1 failed with exit code $LASTEXITCODE"
                }

                Remove-Item "version_info.json" -Force -ErrorAction SilentlyContinue
              } else {
                Write-Host "‚ÑπÔ∏è  No update needed or PR already exists" -ForegroundColor Gray
              }
            }
            catch {
              Write-Warning "Error processing $($file.Name): $_"
            }
          }

          Write-Host "`n‚úÖ Package updater completed" -ForegroundColor Green
        env:
          GITHUB_TOKEN: ${{ secrets.WINGET_PKGS_TOKEN || github.token }}
          GH_TOKEN: ${{ secrets.WINGET_PKGS_TOKEN || github.token }}
          WINGET_FORK_REPO: ${{ secrets.WINGET_FORK_REPO }}
          GITHUB_REPOSITORY_OWNER: ${{ github.repository_owner }}
