name: Update WinGet Packages

on:
  schedule:
    # Run every 4 hours
    - cron: '20 */4 * * *'
  workflow_dispatch:
    inputs:
      package:
        description: 'Package name (leave empty for all packages)'
        required: false
        type: string

permissions:
  contents: read
  pull-requests: write

jobs:
  update:
    name: Check and Update Packages
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup PowerShell modules
        shell: pwsh
        run: |
          if (-not (Get-Module -ListAvailable -Name powershell-yaml)) {
            Install-Module -Name powershell-yaml -Force -Scope CurrentUser
          }
          Write-Host "‚úÖ PowerShell modules ready"

      - name: Run package updater
        shell: pwsh
        run: |
          # Find checkver files
          if ("${{ github.event.inputs.package }}") {
            $checkverFiles = Get-ChildItem -Path manifests -Filter "${{ github.event.inputs.package }}.checkver.yaml" -Recurse
          } else {
            $checkverFiles = Get-ChildItem -Path manifests -Filter "*.checkver.yaml" -Recurse
          }

          Write-Host "Found $($checkverFiles.Count) checkver file(s)" -ForegroundColor Cyan

          foreach ($file in $checkverFiles) {
            Write-Host "`n========================================" -ForegroundColor Cyan
            Write-Host "Processing: $($file.Name)" -ForegroundColor Cyan
            Write-Host "========================================" -ForegroundColor Cyan

            try {
              # Automated Update Flow:
              # Step 1: Check latest version in microsoft/winget-pkgs
              # Step 2: Check latest version from package homepage/source
              # Step 3: Compare versions to determine if update is needed
              # Step 4: Check if PR already exists for this version
              # Step 5: Create manifest update and PR if all checks pass

              # Cleanup any previous version info
              if (Test-Path "version_info.json") {
                Remove-Item "version_info.json" -Force
              }

              # Steps 1-3: Check for updates (checks both winget-pkgs and source)
              pwsh -File scripts/Check-Version.ps1 "$($file.FullName)" "version_info.json"

              if ($LASTEXITCODE -eq 0 -and (Test-Path "version_info.json")) {
                # Step 3: Parse version information
                $versionInfo = Get-Content "version_info.json" -Raw | ConvertFrom-Json
                $packageId = $versionInfo.packageIdentifier
                $version = $versionInfo.version

                Write-Host "‚ú® New version detected: $packageId $version" -ForegroundColor Green

                # Step 4: Check for existing PRs before creating a new one
                Write-Host "üîç Checking for existing PRs in microsoft/winget-pkgs..." -ForegroundColor Cyan
                $searchQuery = "$packageId $version in:title"
                $prs = gh pr list --repo microsoft/winget-pkgs --search $searchQuery --state all --json number,title,state --limit 10 2>$null | ConvertFrom-Json

                $shouldSkip = $false

                if ($prs -and $prs.Count -gt 0) {
                  Write-Host "   Found $($prs.Count) potential matching PR(s)" -ForegroundColor Gray
                  foreach ($pr in $prs) {
                    if ($pr.title -match [regex]::Escape($packageId) -and $pr.title -match [regex]::Escape($version)) {
                      if ($pr.state -in @("OPEN", "MERGED")) {
                        Write-Host "   ‚ö†Ô∏è  PR #$($pr.number) is already $($pr.state): $($pr.title)" -ForegroundColor Yellow
                        Write-Host "‚è≠Ô∏è  Skipping PR creation to avoid duplicates" -ForegroundColor Yellow
                        $shouldSkip = $true
                        break
                      }
                      elseif ($pr.state -eq "CLOSED") {
                        Write-Host "   ‚ÑπÔ∏è  PR #$($pr.number) was closed: $($pr.title)" -ForegroundColor Gray
                      }
                    }
                  }
                } else {
                  Write-Host "   ‚úì No existing PRs found" -ForegroundColor Green
                }

                # Step 5: Create manifest update and PR if no conflicts
                if (-not $shouldSkip) {
                  Write-Host "üöÄ Creating manifest update and PR..." -ForegroundColor Green
                  pwsh -File scripts/Update-Manifest.ps1 "$($file.FullName)" "$packageId" "$version"
                } else {
                  Write-Host "‚è≠Ô∏è  Skipped manifest update" -ForegroundColor Yellow
                }

                Remove-Item "version_info.json" -Force -ErrorAction SilentlyContinue
              } else {
                Write-Host "‚ÑπÔ∏è  No update needed" -ForegroundColor Gray
              }
            }
            catch {
              Write-Warning "Error processing $($file.Name): $_"
            }
          }

          Write-Host "`n‚úÖ Package updater completed" -ForegroundColor Green
        env:
          GITHUB_TOKEN: ${{ secrets.WINGET_PKGS_TOKEN || github.token }}
          GH_TOKEN: ${{ secrets.WINGET_PKGS_TOKEN || github.token }}
          WINGET_FORK_REPO: ${{ secrets.WINGET_FORK_REPO }}
          GITHUB_REPOSITORY_OWNER: ${{ github.repository_owner }}
