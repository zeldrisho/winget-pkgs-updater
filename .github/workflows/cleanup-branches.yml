name: Cleanup PR Branches

on:
  schedule:
    # Run daily at 00:00 UTC
    - cron: '0 0 * * *'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  cleanup-branches:
    name: Cleanup PR branches
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup PowerShell modules
        shell: pwsh
        run: |
          Install-Module -Name powershell-yaml -Force -Scope CurrentUser
      
      - name: Delete branches from merged or outdated closed PRs
        shell: pwsh
        run: |
          # Import WinGetUpdater module
          Import-Module "$env:GITHUB_WORKSPACE/scripts/WinGetUpdater.psm1" -Force

          $ErrorActionPreference = 'Continue'
          $forkRepo = "${{ secrets.WINGET_FORK_REPO }}"
          if (-not $forkRepo) {
            $forkRepo = "${{ github.repository_owner }}/winget-pkgs"
          }

          Write-Host "üîç Checking for merged and closed PRs in microsoft/winget-pkgs..."
          Write-Host "Fork repository: $forkRepo"

          # Get all merged PRs
          $mergedPrsJson = gh pr list `
            --repo microsoft/winget-pkgs `
            --author "${{ github.repository_owner }}" `
            --state merged `
            --limit 100 `
            --json number,title,headRefName,headRepository
          $mergedPrs = $mergedPrsJson | ConvertFrom-Json

          # Get all closed (non-merged) PRs
          $closedPrsJson = gh pr list `
            --repo microsoft/winget-pkgs `
            --author "${{ github.repository_owner }}" `
            --state closed `
            --limit 100 `
            --json number,title,headRefName,headRepository
          $closedPrs = $closedPrsJson | ConvertFrom-Json

          $mergedCount = if ($mergedPrs) { $mergedPrs.Count } else { 0 }
          $closedCount = if ($closedPrs) { $closedPrs.Count } else { 0 }

          Write-Host "Found $mergedCount merged PR(s)"
          Write-Host "Found $closedCount closed PR(s)"

          if ($mergedCount -eq 0 -and $closedCount -eq 0) {
            Write-Host "‚úÖ No merged or closed PRs found"
            exit 0
          }

          # Clone fork repository
          Write-Host ""
          Write-Host "üì• Cloning fork repository..."
          git clone --depth 1 "https://x-access-token:$env:GH_TOKEN@github.com/$forkRepo.git" fork_repo
          Set-Location fork_repo

          # Configure git user
          $userInfo = gh api user | ConvertFrom-Json
          $gitName = if ($userInfo.name) { $userInfo.name } else { $userInfo.login }
          $gitEmail = "$($userInfo.id)+$($userInfo.login)@users.noreply.github.com"

          git config user.name $gitName
          git config user.email $gitEmail
          Write-Host "‚úÖ Configured Git with user: $gitName <$gitEmail>"

          $deletedCount = 0
          $skippedCount = 0
          $errorCount = 0

          # Function to extract package identifier and version from PR title
          function Get-PackageVersionFromTitle {
            param([string]$Title)

            $packageId = ""
            $version = ""

            # Pattern 1: "New version: PackageIdentifier version X.Y.Z"
            if ($Title -match '^New version:\s+([^\s]+)\s+version\s+([\d\.]+)') {
              $packageId = $matches[1]
              $version = $matches[2]
            }
            # Pattern 2: "Update PackageIdentifier to X.Y.Z"
            elseif ($Title -match '^Update\s+([^\s]+)\s+to\s+([\d\.]+)') {
              $packageId = $matches[1]
              $version = $matches[2]
            }
            # Fallback: extract any package-like identifier and version
            elseif ($Title -match '^([A-Z][a-zA-Z0-9]*\.[A-Z][a-zA-Z0-9\.]+).*?([\d\.]+)') {
              $packageId = $matches[1]
              $version = $matches[2]
            }

            return @{
              PackageId = $packageId
              Version = $version
            }
          }

          # Function to get latest version from microsoft/winget-pkgs
          function Get-LatestWinGetVersionFromAPI {
            param([string]$PackageId)

            # Derive manifest path
            $parts = $PackageId.Split('.')
            $first = $parts[0].Substring(0, 1).ToLower()

            # Try standard pattern first
            $manifestPath = "manifests/$first/$($parts -join '/')"

            try {
              $response = gh api "/repos/microsoft/winget-pkgs/contents/$manifestPath" 2>$null | ConvertFrom-Json
              if ($response) {
                # Get version folders
                $versions = $response | Where-Object { $_.type -eq 'dir' } | Select-Object -ExpandProperty name
                if ($versions) {
                  # Use .NET version type for semantic versioning
                  $latestVersion = $versions | ForEach-Object {
                    try {
                      [version]$_
                    } catch {
                      $null
                    }
                  } | Where-Object { $_ } | Sort-Object -Descending | Select-Object -First 1

                  if ($latestVersion) {
                    return $latestVersion.ToString()
                  }
                }
              }
            } catch {
              # Path not found, return empty
            }

            return ""
          }

          # Function to compare versions
          function Test-VersionLessOrEqual {
            param([string]$Version1, [string]$Version2)

            if (-not $Version1 -or -not $Version2) {
              return $false
            }

            try {
              $v1 = [version]$Version1
              $v2 = [version]$Version2
              return $v1 -le $v2
            } catch {
              # Fallback to string comparison
              return $Version1 -le $Version2
            }
          }

          # Process merged PRs
          Write-Host ""
          Write-Host "üóëÔ∏è  Processing merged PRs (will delete all branches)..."
          if ($mergedPrs) {
            foreach ($pr in $mergedPrs) {
              Write-Host ""
              Write-Host "üîç Processing merged PR #$($pr.number): $($pr.title)"
              Write-Host "   Branch: $($pr.headRefName)"

              $headRepo = if ($pr.headRepository) { $pr.headRepository.nameWithOwner } else { "" }

              if ($headRepo) {
                Write-Host "   Repository: $headRepo"
                if ($headRepo -ne $forkRepo) {
                  Write-Host "   ‚è≠Ô∏è  Branch from different repo - skipping"
                  $skippedCount++
                  continue
                }
              } else {
                Write-Host "   Repository: (not available - will check if branch exists)"
              }

              # Check if branch exists
              $branchExists = git ls-remote --heads origin $pr.headRefName | Select-String $pr.headRefName
              if ($branchExists) {
                Write-Host "   üóëÔ∏è  Deleting merged PR branch from fork..."
                try {
                  git push origin --delete $pr.headRefName 2>&1 | Out-Null
                  Write-Host "   ‚úÖ Branch deleted successfully (PR was merged)"
                  $deletedCount++
                } catch {
                  Write-Host "   ‚ö†Ô∏è  Failed to delete branch"
                  $errorCount++
                }
              } else {
                Write-Host "   ‚ÑπÔ∏è  Branch already deleted"
                $skippedCount++
              }
            }
          }

          # Process closed PRs
          Write-Host ""
          Write-Host "üîç Processing closed PRs (checking for outdated versions)..."
          if ($closedPrs) {
            foreach ($pr in $closedPrs) {
              Write-Host ""
              Write-Host "üîç Processing closed PR #$($pr.number): $($pr.title)"
              Write-Host "   Branch: $($pr.headRefName)"

              $headRepo = if ($pr.headRepository) { $pr.headRepository.nameWithOwner } else { "" }

              if ($headRepo) {
                Write-Host "   Repository: $headRepo"
                if ($headRepo -ne $forkRepo) {
                  Write-Host "   ‚è≠Ô∏è  Branch from different repo - skipping"
                  $skippedCount++
                  continue
                }
              } else {
                Write-Host "   Repository: (not available - will check if branch exists)"
              }

              # Check if branch exists
              $branchExists = git ls-remote --heads origin $pr.headRefName | Select-String $pr.headRefName
              if (-not $branchExists) {
                Write-Host "   ‚ÑπÔ∏è  Branch already deleted"
                $skippedCount++
                continue
              }

              # Extract package info from title
              $packageInfo = Get-PackageVersionFromTitle -Title $pr.title
              $packageId = $packageInfo.PackageId
              $prVersion = $packageInfo.Version

              Write-Host "   Package: $packageId"
              Write-Host "   PR Version: $prVersion"

              if (-not $packageId -or -not $prVersion) {
                Write-Host "   ‚ö†Ô∏è  Could not extract package info from title - skipping"
                $skippedCount++
                continue
              }

              # Get latest version
              Write-Host "   üîç Checking latest version in microsoft/winget-pkgs..."
              $latestVersion = Get-LatestWinGetVersionFromAPI -PackageId $packageId

              if (-not $latestVersion) {
                Write-Host "   ‚ö†Ô∏è  Could not determine latest version from microsoft/winget-pkgs - skipping"
                $skippedCount++
                continue
              }

              Write-Host "   Latest in microsoft/winget-pkgs: $latestVersion"

              # Compare versions
              if (Test-VersionLessOrEqual -Version1 $prVersion -Version2 $latestVersion) {
                Write-Host "   üóëÔ∏è  PR version ($prVersion) ‚â§ Latest ($latestVersion) - deleting branch..."
                try {
                  git push origin --delete $pr.headRefName 2>&1 | Out-Null
                  Write-Host "   ‚úÖ Branch deleted successfully (version already in repo or outdated)"
                  $deletedCount++
                } catch {
                  Write-Host "   ‚ö†Ô∏è  Failed to delete branch"
                  $errorCount++
                }
              } else {
                Write-Host "   ‚ÑπÔ∏è  PR version ($prVersion) > Latest ($latestVersion) - keeping branch (newer version, can retry)"
                $skippedCount++
              }
            }
          }

          # Summary
          Write-Host ""
          Write-Host "üìä Summary:"
          Write-Host "   Total PRs processed: $($mergedCount + $closedCount)"
          Write-Host "   - Merged PRs: $mergedCount (all branches deleted if found)"
          Write-Host "   - Closed PRs: $closedCount (only outdated versions deleted)"
          Write-Host "   Branches deleted: $deletedCount"
          Write-Host "   Already deleted/skipped: $skippedCount"
          Write-Host "   Errors: $errorCount"

          # GitHub step summary
          @"
          ## üßπ Branch Cleanup Summary

          ### Cleanup Policy
          - **Merged PRs**: Delete all branches (PR was accepted)
          - **Closed PRs**: Delete only if version ‚â§ latest in microsoft/winget-pkgs

          ### Results
          - **Total PRs processed:** $($mergedCount + $closedCount)
            - Merged PRs: $mergedCount
            - Closed PRs: $closedCount
          - **Branches deleted:** $deletedCount
          - **Already deleted/skipped:** $skippedCount
          - **Errors:** $errorCount
          "@ | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append

          exit 0
        env:
          GH_TOKEN: ${{ secrets.WINGET_PKGS_TOKEN || github.token }}
