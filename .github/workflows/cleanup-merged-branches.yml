name: Cleanup Merged PR Branches

on:
  schedule:
    # Run daily at 00:00 UTC
    - cron: '0 0 * * *'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  cleanup-merged-branches:
    name: Cleanup merged PR branches
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Delete merged PR branches from fork
        run: |
          set +e  # Don't exit on error - we want to continue processing all PRs
          
          fork_repo="${{ secrets.WINGET_FORK_REPO || format('{0}/winget-pkgs', github.repository_owner) }}"
          
          echo "ðŸ” Checking for merged PRs in microsoft/winget-pkgs..."
          echo "Fork repository: $fork_repo"
          
          # Get all merged PRs created by the fork owner
          merged_prs=$(gh pr list \
            --repo microsoft/winget-pkgs \
            --author "${{ github.repository_owner }}" \
            --state merged \
            --limit 100 \
            --json number,title,headRefName,headRepository)
          
          if [ -z "$merged_prs" ] || [ "$merged_prs" = "[]" ]; then
            echo "âœ… No merged PRs found"
            exit 0
          fi
          
          pr_count=$(echo "$merged_prs" | jq 'length')
          echo "Found $pr_count merged PR(s)"
          
          # Clone the fork to delete branches using git
          echo ""
          echo "ðŸ“¥ Cloning fork repository..."
          git clone --depth 1 "https://x-access-token:${GH_TOKEN}@github.com/${fork_repo}.git" fork_repo
          cd fork_repo
          
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          deleted_count=0
          skipped_count=0
          error_count=0
          
          for i in $(seq 0 $((pr_count - 1))); do
            pr=$(echo "$merged_prs" | jq -r ".[$i]")
            pr_number=$(echo "$pr" | jq -r '.number')
            pr_title=$(echo "$pr" | jq -r '.title')
            branch_name=$(echo "$pr" | jq -r '.headRefName')
            head_repo=$(echo "$pr" | jq -r '.headRepository.nameWithOwner // ""')
            
            # Skip if head repository info is missing (branch already deleted from fork)
            if [ -z "$head_repo" ] || [ "$head_repo" = "null" ]; then
              echo "â­ï¸  PR #$pr_number - head repository info missing (branch likely deleted) - skipping"
              skipped_count=$((skipped_count + 1))
              continue
            fi
            
            # Only process branches from our fork
            if [ "$head_repo" != "$fork_repo" ]; then
              echo "â­ï¸  PR #$pr_number - branch from different repo ($head_repo) - skipping"
              skipped_count=$((skipped_count + 1))
              continue
            fi
            
            echo ""
            echo "ðŸ” Processing PR #$pr_number: $pr_title"
            echo "   Branch: $branch_name"
            echo "   Repository: $head_repo"
            
            # Check if branch exists on remote
            if git ls-remote --heads origin "$branch_name" | grep -q "$branch_name"; then
              echo "   ðŸ—‘ï¸  Deleting branch from fork..."
              if git push origin --delete "$branch_name" 2>&1; then
                echo "   âœ… Branch deleted successfully"
                deleted_count=$((deleted_count + 1))
              else
                echo "   âš ï¸  Failed to delete branch"
                error_count=$((error_count + 1))
              fi
            else
              echo "   â„¹ï¸  Branch already deleted"
              skipped_count=$((skipped_count + 1))
            fi
          done
          
          echo ""
          echo "ðŸ“Š Summary:"
          echo "   Total merged PRs: $pr_count"
          echo "   Branches deleted: $deleted_count"
          echo "   Already deleted/skipped: $skipped_count"
          echo "   Errors: $error_count"
          
          # Add to GitHub step summary
          echo "## ðŸ§¹ Branch Cleanup Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Total merged PRs:** $pr_count" >> $GITHUB_STEP_SUMMARY
          echo "- **Branches deleted:** $deleted_count" >> $GITHUB_STEP_SUMMARY
          echo "- **Already deleted/skipped:** $skipped_count" >> $GITHUB_STEP_SUMMARY
          echo "- **Errors:** $error_count" >> $GITHUB_STEP_SUMMARY
          
          # Exit with success (0) regardless of individual branch deletion errors
          exit 0
        env:
          GH_TOKEN: ${{ secrets.WINGET_PKGS_TOKEN || github.token }}
